{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <h1 class="text-3xl font-bold">Manage Habits</h1>
    <button class="btn btn-primary" onclick="document.getElementById('new-habit-modal').showModal()">
      Add Habit
    </button>
  </div>

  <!-- Habits List -->
  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for habit in habits %}
    <div class="card bg-base-200 shadow-xl" x-data="{ showEdit: false }">
      <div class="card-body">
        <div class="flex justify-between items-start">
          <h2 class="card-title {% if not habit.is_good %}text-error{% endif %}">
            {{ habit.name }}
          </h2>
          <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-ghost btn-sm btn-square">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
              </svg>
            </label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
              <li>
                <button @click="showEdit = true">
                  Edit
                </button>
              </li>
              <li>
                <button class="text-error" hx-delete="/habits/{{ habit.id }}"
                  hx-confirm="Are you sure you want to delete this habit?" hx-target="closest .card"
                  hx-swap="outerHTML">
                  Delete
                </button>
              </li>
            </ul>
          </div>
        </div>

        <div class="flex gap-2 mt-2">
          <div class="badge {% if habit.is_good %}badge-success{% else %}badge-error{% endif %}">
            {{ "Good" if habit.is_good else "Bad" }}
          </div>
          {% if habit.goal_streak %}
          <div class="badge badge-primary">
            Goal: {{ habit.goal_streak }} days
          </div>
          {% endif %}
        </div>

        <div class="stats stats-vertical shadow mt-4">
          <div class="stat">
            <div class="stat-title">Current Streak</div>
            <div class="stat-value">{{ habit.current_streak }}</div>
            <div class="stat-desc">days</div>
          </div>
          <div class="stat">
            <div class="stat-title">Longest Streak</div>
            <div class="stat-value">{{ habit.longest_streak }}</div>
            <div class="stat-desc">days</div>
          </div>
        </div>

        <!-- Edit Form -->
        <dialog class="modal" :open="showEdit">
          <div class="modal-box">
            <h3 class="font-bold text-lg">Edit Habit</h3>
            <form class="mt-4" x-data="{
                            name: '{{ habit.name }}',
                            is_good: {{ 'true' if habit.is_good else 'false' }},
                            goal_streak: {{ habit.goal_streak or 'null' }},
                            error: ''
                        }" @submit.prevent="
                            fetch('/habits/{{ habit.id }}', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    name: name,
                                    is_good: is_good,
                                    goal_streak: goal_streak
                                })
                            }).then(async response => {
                                if (!response.ok) {
                                    const data = await response.json();
                                    throw new Error(data.detail || 'Failed to update habit');
                                }
                                showEdit = false;
                                window.location.reload();
                            }).catch(err => {
                                error = err.message;
                            })">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">Name</span>
                </label>
                <input type="text" x-model="name" class="input input-bordered" required />
              </div>

              <div class="form-control mt-4">
                <label class="label cursor-pointer">
                  <span class="label-text">Type</span>
                  <input type="checkbox" x-model="is_good" class="toggle toggle-success" />
                </label>
                <span class="text-sm mt-1" x-text="is_good ? 'Good Habit' : 'Bad Habit'"></span>
              </div>

              <div class="form-control mt-4">
                <label class="label">
                  <span class="label-text">Goal Streak (days)</span>
                </label>
                <input type="number" x-model="goal_streak" class="input input-bordered" min="1" />
              </div>

              <div x-show="error" x-cloak class="alert alert-error mt-4">
                <span x-text="error"></span>
              </div>

              <div class="modal-action">
                <button type="button" class="btn" @click="showEdit = false">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
          <form method="dialog" class="modal-backdrop">
            <button @click="showEdit = false">close</button>
          </form>
        </dialog>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- New Habit Modal -->
  <dialog id="new-habit-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">New Habit</h3>
      <form class="mt-4" x-data="{
                name: '',
                is_good: true,
                goal_streak: null,
                error: ''
            }" @submit.prevent="
                fetch('/habits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        is_good: is_good,
                        goal_streak: goal_streak
                    })
                }).then(async response => {
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.detail || 'Failed to create habit');
                    }
                    document.getElementById('new-habit-modal').close();
                    window.location.reload();
                }).catch(err => {
                    error = err.message;
                })">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Name</span>
          </label>
          <input type="text" x-model="name" class="input input-bordered" required />
        </div>

        <div class="form-control mt-4">
          <label class="label cursor-pointer">
            <span class="label-text">Type</span>
            <input type="checkbox" x-model="is_good" class="toggle toggle-success" />
          </label>
          <span class="text-sm mt-1" x-text="is_good ? 'Good Habit' : 'Bad Habit'"></span>
        </div>

        <div class="form-control mt-4">
          <label class="label">
            <span class="label-text">Goal Streak (days)</span>
          </label>
          <input type="number" x-model="goal_streak" class="input input-bordered" min="1" />
        </div>

        <div x-show="error" x-cloak class="alert alert-error mt-4">
          <span x-text="error"></span>
        </div>

        <div class="modal-action">
          <button type="button" class="btn" onclick="document.getElementById('new-habit-modal').close()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</div>
{% endblock %}